<!DOCTYPE html>
<html lang=zh-CN>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:description" content="">
    <meta property="og:type" content="website">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        MPI学习 - Vicczyq | 记录学习和生活
        
    </title>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/aircloud.css">

    
<link rel="stylesheet" href="/css/gitment.css">

    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_28hi1hpxx24.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>

    









<meta name="generator" content="Hexo 7.1.0"></head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> 好好生活，保持热爱，无惧无畏，奔赴山海 </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar radius">
            <img src="//q2.qlogo.cn/headimg_dl?dst_uin=1740674168&amp;spec=140" />
        </div>
        <div class="name">
            <i>Vicczyq | 长木乔</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/collect/">
                    <i class="iconfont icon-shoucang1"></i>
                    <span>收藏</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80hello-world"><span class="toc-text">一、Hello world</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E5%9F%BA%E6%9C%ACapi"><span class="toc-text">二、基本API</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E7%8E%AF%E5%A2%83-mpi_init"><span class="toc-text">2.1 初始化环境 MPI_Init</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%98%AF%E5%90%A6%E5%88%9D%E5%A7%8B%E5%8C%96mpi_initialized"><span class="toc-text">2.2 是否初始化：MPI_Initialized</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%88%E6%AD%A2%E7%8E%AF%E5%A2%83mpi_finalized"><span class="toc-text">2.3 终止环境：MPI_Finalized</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E8%BF%9B%E7%A8%8B%E6%95%B0mpi_comm_size"><span class="toc-text">2.4 获取进程数：MPI_Comm_size</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E8%BF%9B%E7%A8%8Bidmpi_comm_rank"><span class="toc-text">2.5 获取进程ID：MPI_Comm_rank</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%A8%8B%E5%BA%8F%E8%BF%90%E8%A1%8C%E7%9A%84%E4%B8%BB%E6%9C%BA%E5%90%8D"><span class="toc-text">2.6 获取程序运行的主机名</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%88%E6%AD%A2%E4%B8%80%E4%B8%AAcomm%E7%9A%84%E6%89%80%E6%9C%89%E8%BF%9B%E7%A8%8Bmpi_abort"><span class="toc-text">2.7
终止一个comm的所有进程：MPI_Abort</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E6%A0%85%E6%A0%8F%E5%87%BD%E6%95%B0-mpi_barrier"><span class="toc-text">2.8 同步栅栏函数 MPI_Barrier</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E9%80%9A%E4%BF%A1api"><span class="toc-text">三、通信API</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#mpi%E6%B6%88%E6%81%AF%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-text">3.1 MPI消息数据类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%82%B9%E5%AF%B9%E7%82%B9%E9%80%9A%E4%BF%A1"><span class="toc-text">3.2 点对点通信</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E5%90%88%E9%80%9A%E4%BF%A1"><span class="toc-text">3.3 集合通信</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B9%BF%E6%92%AD-bcast"><span class="toc-text">3.3.1 广播 Bcast</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%8F%91-scatter"><span class="toc-text">3.3.2 分发 Scatter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%B6%E9%9B%86-gather"><span class="toc-text">3.3.3 收集 Gather</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E6%94%B6%E9%9B%86-allgather"><span class="toc-text">3.3.4 全收集 Allgather</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%84%E7%BA%A6-reduce"><span class="toc-text">3.3.5 规约 Reduce</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E8%A7%84%E7%BA%A6-allreduce"><span class="toc-text">3.3.6 全规约 Allreduce</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E4%BF%A1%E5%9F%9F%E5%92%8C%E8%BF%9B%E7%A8%8B%E7%BB%84"><span class="toc-text">3.4 通信域和进程组</span></a></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-bg" id="search-bg"></div>
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i> 好好生活，保持热爱，无惧无畏，奔赴山海 </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        MPI学习
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2022-02-05 19:27:14</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/tags/#超算" title="超算">超算</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <h1 id="一hello-world">一、Hello world</h1>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mpi.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="built_in">MPI_Init</span>(<span class="literal">NULL</span>,<span class="literal">NULL</span>);</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;hello world&quot;</span> &lt;&lt; endl;</span><br><span class="line">	<span class="built_in">MPI_Finalize</span>();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mpicxx hello.cpp -o hello</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mpirun -np 10 ./hello</span><br></pre></td></tr></table></figure>
<p>代码结构：</p>
<ul>
<li>头文件</li>
<li>初始化MPI环境：MPI_Init()</li>
<li>分布式代码</li>
<li>终止MPI环境：MPI_Finalize()</li>
<li>结束</li>
</ul>
<h1 id="二基本api">二、基本API</h1>
<h2 id="初始化环境-mpi_init">2.1 初始化环境 MPI_Init</h2>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">MPI_Init</span><span class="params">(<span class="type">int</span>* argc,<span class="type">char</span>* argv[])</span></span>;</span><br><span class="line"><span class="comment">//参数argc_p和argc_v是指向参数argc和argv的指针，当程序不使用这些参数时可直接写为NULL。</span></span><br><span class="line"><span class="comment">//该函数的返回值一般为一个整型int，我们一般忽略。</span></span><br><span class="line"><span class="comment">//所以一般最常见的用法为：</span></span><br><span class="line"><span class="built_in">MPI_Init</span>(<span class="literal">NULL</span>,<span class="literal">NULL</span>);</span><br><span class="line"><span class="comment">//除此之外，该函数一般表示MPI函数的开始，在此之前不应该有其他MPI函数</span></span><br></pre></td></tr></table></figure>
<h2 id="是否初始化mpi_initialized">2.2 是否初始化：MPI_Initialized</h2>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">MPI_Initialized</span><span class="params">(<span class="type">int</span> *flag)</span></span></span><br></pre></td></tr></table></figure>
<p>唯一可在MPI_Init前使用的函数，用来检测MPI系统是否已经初始化，<strong>已经调用MPI_Init，返回flag=true，否则返回flag=false</strong>。</p>
<h2 id="终止环境mpi_finalized">2.3 终止环境：MPI_Finalized</h2>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">MPI_Finalize</span><span class="params">(<span class="type">void</span>)</span></span></span><br></pre></td></tr></table></figure>
<p>在一个进程执行完其全部MPI函数调用后，将调用函数MPI_Finalize，从而让系统释放分配给MPI的资源（例如内存等）</p>
<h2 id="获取进程数mpi_comm_size">2.4 获取进程数：MPI_Comm_size</h2>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">MPI_Comm_size</span><span class="params">(MPI_Comm comm, <span class="type">int</span>* size)</span></span></span><br></pre></td></tr></table></figure>
<p>通过调用函数来确定一个通信域中的<strong>进程总数</strong>。</p>
<p>如果comm是<code>MPI_COMM_WORLD</code>，那就是当前程序能用的所有进程数</p>
<h2 id="获取进程idmpi_comm_rank">2.5 获取进程ID：MPI_Comm_rank</h2>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">MPI_Comm_rank</span><span class="params">(MPI_Comm comm, <span class="type">int</span>* rank)</span></span></span><br></pre></td></tr></table></figure>
<p><strong>在一个有p个进程的通信域中，每一个进程有一个唯一的序号（ID号），取值为0~p-1</strong>。</p>
<p>当MPI初始化后，每一个活动进程变成了一个叫MPI_COMM_WORLD的通信域中的成员。</p>
<h2 id="获取程序运行的主机名">2.6 获取程序运行的主机名</h2>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">MPI_Get_processor_name</span><span class="params">(<span class="type">char</span>* name, <span class="type">int</span>* resultlen)</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>name：返回名称</li>
<li>resultlen：返回名称所占用的字节</li>
</ul>
<p>应提供参数name不少于MPI_MAX_PROCESSOR_NAME个字节的存储空间。</p>
<h2 id="终止一个comm的所有进程mpi_abort">2.7
终止一个comm的所有进程：MPI_Abort</h2>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">MPI_Abort</span><span class="params">(MPI_Comm comm, <span class="type">int</span> errorcode)</span></span></span><br></pre></td></tr></table></figure>
<p>异常终止MPI程序，在出现了致命错误而希望异常终止MPI程序时执行，MPI系统会设法终止comm通信器中的所有进程，输入整形参数errocode，将被作为进程的退出码返回给系统。</p>
<h2 id="同步栅栏函数-mpi_barrier">2.8 同步栅栏函数 MPI_Barrier</h2>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">MPI_Barrier</span><span class="params">(MPI_Comm communicator)</span></span></span><br></pre></td></tr></table></figure>
<p>可以用二叉树、双回环等方式实现，依靠的是Send、Recv阻塞机制</p>
<h1 id="三通信api">三、通信API</h1>
<ul>
<li>MPI提供了消息的缓存机制</li>
<li>消息可以以阻塞或非阻塞的方式发送</li>
<li>顺序性：MPI保证接收者收到消息的顺序和发送者的发送顺序一致</li>
<li>公平性：MPI不保证调度公平性，程序员自己去防止进程饥饿</li>
</ul>
<h2 id="mpi消息数据类型">3.1 MPI消息数据类型</h2>
<table>
<colgroup>
<col style="width: 25%">
<col style="width: 27%">
<col style="width: 23%">
<col style="width: 23%">
</colgroup>
<thead>
<tr>
<th style="text-align: center;">MPI 数据类型</th>
<th style="text-align: center;">C 语言数据类型</th>
<th style="text-align: center;">MPI 数据类型</th>
<th style="text-align: center;">C 语言数据类型</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">MPI_CHAR</td>
<td style="text-align: center;">signed char</td>
<td style="text-align: center;">MPI_UNSIGNED</td>
<td style="text-align: center;">unsigned int</td>
</tr>
<tr>
<td style="text-align: center;">MPI_SHORT</td>
<td style="text-align: center;">signed short int</td>
<td style="text-align: center;">MPI_UNSIGNED_LONG</td>
<td style="text-align: center;">unsigned long int</td>
</tr>
<tr>
<td style="text-align: center;">MPI_INT</td>
<td style="text-align: center;">signed int</td>
<td style="text-align: center;">MPI_FLOAT</td>
<td style="text-align: center;">float</td>
</tr>
<tr>
<td style="text-align: center;">MPI_LONG</td>
<td style="text-align: center;">signed long int</td>
<td style="text-align: center;">MPI_DOUBLE</td>
<td style="text-align: center;">double</td>
</tr>
<tr>
<td style="text-align: center;">MPI_LONG_LONG</td>
<td style="text-align: center;">signed long long int</td>
<td style="text-align: center;">MPI_LONG_DOUBLE</td>
<td style="text-align: center;">long double</td>
</tr>
<tr>
<td style="text-align: center;">MPI_UNSIGNED_CHAR</td>
<td style="text-align: center;">unsigned char</td>
<td style="text-align: center;">MPI_BYTE</td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td style="text-align: center;">MPI_UNSIGNED_SHORT</td>
<td style="text-align: center;">unsigned short int</td>
<td style="text-align: center;">MPI_PACKED</td>
<td style="text-align: center;"></td>
</tr>
</tbody>
</table>
<h2 id="点对点通信">3.2 点对点通信</h2>
<p><code>status</code>参数用于指出接收的消息的源和标记（status.MPI_SOURCE、status.MPI_TAG）如果不关心这些参数，可以用<code>MPI_STATUS_IGNORE</code></p>
<ul>
<li><p>阻塞发送/接收：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">MPI_Send</span><span class="params">(<span class="type">void</span> *buf, <span class="type">int</span> count, MPI_Datatype datatype, <span class="type">int</span> dest, <span class="type">int</span> tag, MPI_Comm comm)</span></span></span><br><span class="line"><span class="function"><span class="comment">// buf: 发送缓冲区起始地址</span></span></span><br><span class="line"><span class="function"><span class="comment">// count: 发送消息的数据单元个数</span></span></span><br><span class="line"><span class="function"><span class="comment">// datatype: 发送消息的数据类型</span></span></span><br><span class="line"><span class="function"><span class="comment">// dest: 目标进程号</span></span></span><br><span class="line"><span class="function"><span class="comment">// tag: 发送消息的标签</span></span></span><br><span class="line"><span class="function"><span class="comment">// comm: 通信域</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">MPI_Recv</span><span class="params">(<span class="type">void</span> *buf, <span class="type">int</span> count, MPI_Datatype datatype, <span class="type">int</span> source, <span class="type">int</span> tag, MPI_Comm comm, MPI_Status *status)</span></span></span><br><span class="line"><span class="function"><span class="comment">//status可以用MPI_STATUS_IGNORE忽略使用</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;mpi.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> numprocs, myid, source;</span><br><span class="line">    MPI_Status status;</span><br><span class="line">    <span class="type">char</span> message[<span class="number">100</span>];</span><br><span class="line">    <span class="built_in">MPI_Init</span>(&amp;argc, &amp;argv);</span><br><span class="line">    <span class="built_in">MPI_Comm_rank</span>(MPI_COMM_WORLD, &amp;myid);</span><br><span class="line">    <span class="built_in">MPI_Comm_size</span>(MPI_COMM_WORLD, &amp;numprocs);</span><br><span class="line">    <span class="keyword">if</span> (myid != <span class="number">0</span>) &#123;  <span class="comment">//非0号进程发送消息</span></span><br><span class="line">        <span class="built_in">strcpy</span>(message, <span class="string">&quot;Hello World!&quot;</span>);</span><br><span class="line">        <span class="built_in">MPI_Send</span>(message, <span class="built_in">strlen</span>(message) + <span class="number">1</span>, MPI_CHAR, <span class="number">0</span>, <span class="number">99</span>,</span><br><span class="line">            MPI_COMM_WORLD);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;   <span class="comment">// myid == 0，即0号进程接收消息</span></span><br><span class="line">        <span class="keyword">for</span> (source = <span class="number">1</span>; source &lt; numprocs; source++) &#123;</span><br><span class="line">            <span class="built_in">MPI_Recv</span>(message, <span class="number">100</span>, MPI_CHAR, source, <span class="number">99</span>,</span><br><span class="line">                MPI_COMM_WORLD, &amp;status);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;接收到第%d号进程发送的消息：%s\n&quot;</span>, source, message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">MPI_Finalize</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>非阻塞发送/接收：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">MPI_Isend</span><span class="params">(<span class="type">const</span> <span class="type">void</span>* buf, <span class="type">int</span> count, MPI_Datatype datatype, <span class="type">int</span> dest, <span class="type">int</span> tag, MPI_Comm comm, MPI_Request* request)</span></span></span><br><span class="line"><span class="function"><span class="comment">// buf: 发送缓冲区起始地址</span></span></span><br><span class="line"><span class="function"><span class="comment">// count: 发送消息的数据单元个数</span></span></span><br><span class="line"><span class="function"><span class="comment">// datatype: 发送消息的数据类型</span></span></span><br><span class="line"><span class="function"><span class="comment">// dest: 目标进程号</span></span></span><br><span class="line"><span class="function"><span class="comment">// tag: 发送消息的标签</span></span></span><br><span class="line"><span class="function"><span class="comment">// comm: 通信域</span></span></span><br><span class="line"><span class="function"><span class="comment">// request: 非阻塞发送请求对象</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">MPI_Irecv</span><span class="params">(<span class="type">void</span> *buf, <span class="type">int</span> count, MPI_Datatype datatype, <span class="type">int</span> source, <span class="type">int</span> tag, MPI_Comm comm, MPI_Request *request)</span></span></span><br><span class="line"><span class="function"><span class="comment">//通过request可以知道Isend或Irecv的状态（是否完成）</span></span></span><br></pre></td></tr></table></figure>
<p><code>MPI_Wait</code>用于等待某一个通信的完成，<code>MPI_Waitall</code>等待一组通信的完成</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">MPI_Wait</span><span class="params">(MPI_Request *request, MPI_Status *status)</span></span></span><br><span class="line"><span class="function"><span class="comment">//status可用`MPI_STATUS_IGNORE`代替</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mpi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">MPI_Init</span>(&amp;argc, &amp;argv);</span><br><span class="line">    <span class="type">int</span> rank, size;</span><br><span class="line">    <span class="built_in">MPI_Comm_rank</span>(MPI_COMM_WORLD, &amp;rank);</span><br><span class="line">    <span class="built_in">MPI_Comm_size</span>(MPI_COMM_WORLD, &amp;size);</span><br><span class="line">    <span class="keyword">if</span> (size != <span class="number">2</span>) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;This program requires exactly 2 MPI processes.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="built_in">MPI_Abort</span>(MPI_COMM_WORLD, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> N = <span class="number">10</span>;</span><br><span class="line">    <span class="function">std::vector&lt;<span class="type">int</span>&gt; <span class="title">data</span><span class="params">(N)</span></span>;</span><br><span class="line">    MPI_Request request;</span><br><span class="line">    MPI_Status status;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rank == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; N; ++i) &#123;</span><br><span class="line">            data[i] = i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">MPI_Isend</span>(data.<span class="built_in">data</span>(), N, MPI_INT, <span class="number">1</span>, <span class="number">0</span>, MPI_COMM_WORLD, &amp;request);</span><br><span class="line">        <span class="built_in">MPI_Wait</span>(&amp;request, &amp;status);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rank == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">MPI_Irecv</span>(data.<span class="built_in">data</span>(), N, MPI_INT, <span class="number">0</span>, <span class="number">0</span>, MPI_COMM_WORLD, &amp;request);</span><br><span class="line">        <span class="built_in">MPI_Wait</span>(&amp;request, &amp;status);</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Process 1: Data received.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Process 1: Received data = &quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; N; ++i) &#123;</span><br><span class="line">            std::cout &lt;&lt; data[i] &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        std::cout &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">MPI_Finalize</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="集合通信">3.3 集合通信</h2>
<h3 id="广播-bcast">3.3.1 广播 Bcast</h3>
<p>从指定的一个根进程中把<strong>相同的数据</strong>广播发送给组中的所有其他进程</p>
<figure>
<img src="/2022/02/05/MPI%E5%AD%A6%E4%B9%A0/793e4b95df5f473ab6a917b3351d5c2c.png" alt="img">
<figcaption aria-hidden="true">img</figcaption>
</figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">MPI_Bcast</span>(</span><br><span class="line">    <span class="type">void</span> *buffer,</span><br><span class="line">    <span class="type">int</span> count,</span><br><span class="line">    MPI_Datatype datatype,</span><br><span class="line">    <span class="type">int</span> root,</span><br><span class="line">    MPI_Comm comm)</span><br></pre></td></tr></table></figure>
<p>for循环调用MPI_Send和MPI_Recv也能实现广播的效果，但是<strong>时间复杂度</strong>有很大的区别，for循环实现时间复杂度为<strong>O(n)</strong>，Bcast实现时间复杂度为<strong>O(logn)</strong></p>
<p><strong>Bcast的实现示意图：</strong></p>
<figure>
<img src="/2022/02/05/MPI%E5%AD%A6%E4%B9%A0/broadcast_tree.png" alt="MPI_Bcast tree">
<figcaption aria-hidden="true">MPI_Bcast tree</figcaption>
</figure>
<ul>
<li><strong>T0时刻：</strong>0号进程将数据传递给1号进程</li>
<li><strong>T1时刻：</strong>0号进程和1号进程都有了数据，0号进程将数据发送给2号进程，1号进程发送给3号进程</li>
<li><strong>T2时刻：</strong>0-&gt;4，1-&gt;5，2-&gt;6，3-&gt;7</li>
</ul>
<h3 id="分发-scatter">3.3.2 分发 Scatter</h3>
<p>把指定的根进程中的数据<strong>分散</strong>发送给组中的所有进程（<strong>包括自己</strong>）</p>
<figure>
<img src="/2022/02/05/MPI%E5%AD%A6%E4%B9%A0/5b0f095e18a74d38b739034c496a1e15.png" alt="img">
<figcaption aria-hidden="true">img</figcaption>
</figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">MPI_Scatter</span>(</span><br><span class="line">    <span class="type">void</span>* send_data,<span class="type">int</span> send_count,MPI_Datatype send_datatype,</span><br><span class="line">    <span class="type">void</span>* recv_data,<span class="type">int</span> recv count,MPI_Datatype recv_datatype,</span><br><span class="line">    <span class="type">int</span> root,MPI_Comm communicator)</span><br></pre></td></tr></table></figure>
<h3 id="收集-gather">3.3.3 收集 Gather</h3>
<p>在组中指定一个进程收集组中进程发来的消息，这个函数操作与MPI_Scatter函数操作相反
所有进程调用该函数，把指定位置的数据发送给根进程的指定位置</p>
<figure>
<img src="/2022/02/05/MPI%E5%AD%A6%E4%B9%A0/b5d9b251e1c643ce83ae9db8440eab5c.png" alt="img">
<figcaption aria-hidden="true">img</figcaption>
</figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">MPI_Gather</span>(</span><br><span class="line">    <span class="type">void</span> *sendbuf,<span class="type">int</span> sent_count,MPI_Datatype send_datatype,</span><br><span class="line">    <span class="type">void</span> *recv_data,<span class="type">int</span> recv_count,MPI_Datatype recv_datatype,</span><br><span class="line">    <span class="type">int</span> root,MPI_Comm communicator)</span><br></pre></td></tr></table></figure>
<h3 id="全收集-allgather">3.3.4 全收集 Allgather</h3>
<p>将所有的数据聚合到每个进程中。</p>
<figure>
<img src="/2022/02/05/MPI%E5%AD%A6%E4%B9%A0/image-20240526132009884.png" alt="image-20240526132009884">
<figcaption aria-hidden="true">image-20240526132009884</figcaption>
</figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">MPI_Allgather</span>(</span><br><span class="line">    <span class="type">void</span>* send_data,<span class="type">int</span> send_count,MPI_Datatype send_datatype,</span><br><span class="line">    <span class="type">void</span>* recv_data,<span class="type">int</span> recv_count,MPI_Datatype recv_datatype,</span><br><span class="line">    MPI_Comm communicator)</span><br></pre></td></tr></table></figure>
<p>与gather的区别就是没有<code>root</code>参数</p>
<h3 id="规约-reduce">3.3.5 规约 Reduce</h3>
<p>将每个进程中的数据按给定的操作op进行运算，并将其结果返回到序列号为root的进程。</p>
<figure>
<img src="/2022/02/05/MPI%E5%AD%A6%E4%B9%A0/image-20240526132613368.png" alt="image-20240526132613368">
<figcaption aria-hidden="true">image-20240526132613368</figcaption>
</figure>
<p>可以处理多个值</p>
<figure>
<img src="/2022/02/05/MPI%E5%AD%A6%E4%B9%A0/modb_20211208_35345a7a-580d-11ec-bc47-fa163eb4f6be.png" alt="img">
<figcaption aria-hidden="true">img</figcaption>
</figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">MPI_Reduce</span>(</span><br><span class="line">	<span class="type">void</span> *send_data,</span><br><span class="line">	<span class="type">void</span> *recv_data, </span><br><span class="line">	<span class="type">int</span> count,</span><br><span class="line">	MPI_Datatype datatype,</span><br><span class="line">	MPI_Op <span class="keyword">operator</span>,<span class="comment">/*操作*/</span></span><br><span class="line">	<span class="type">int</span> root,</span><br><span class="line">	MPI_Comm comm);</span><br></pre></td></tr></table></figure>
<figure>
<img src="/2022/02/05/MPI%E5%AD%A6%E4%B9%A0/20151125101509006.png" alt="opration">
<figcaption aria-hidden="true">opration</figcaption>
</figure>
<h3 id="全规约-allreduce">3.3.6 全规约 Allreduce</h3>
<figure>
<img src="/2022/02/05/MPI%E5%AD%A6%E4%B9%A0/u=1777912551,215306698&amp;fm=30&amp;app=106&amp;f=JPEG.jpeg" alt="MPI，OpenMPI与深度学习-有驾">
<figcaption aria-hidden="true">MPI，OpenMPI与深度学习-有驾</figcaption>
</figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">MPI_Allreduce</span>(</span><br><span class="line">    <span class="type">void</span>* send_data,</span><br><span class="line">    <span class="type">void</span>* recv_data,</span><br><span class="line">    <span class="type">int</span> count,</span><br><span class="line">    MPI_Datatype datatype,</span><br><span class="line">    MPI_Op op,</span><br><span class="line">    MPI_Comm communicator)</span><br></pre></td></tr></table></figure>
<h2 id="通信域和进程组">3.4 通信域和进程组</h2>
<p><strong>进程组</strong>就是一组并行运行的MPI进程的集合，同一进程可以属于不同的进程组</p>
<p>一个进程组可以包含任意数量的进程，而一个通信域由一个进程组构成，但一个进程组可以用于创建多个不同的通信域。</p>
<p>在之前的MPI学习中一直使用的通信域MPI_COMM_WORLD<strong>所对应的</strong>进程组就是全体进程的集合</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mpi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="built_in">MPI_Init</span>(&amp;argc, &amp;argv);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> rank, size;</span><br><span class="line">    <span class="built_in">MPI_Comm_rank</span>(MPI_COMM_WORLD, &amp;rank);</span><br><span class="line">    <span class="built_in">MPI_Comm_size</span>(MPI_COMM_WORLD, &amp;size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取默认通信域的进程组</span></span><br><span class="line">    MPI_Group world_group;</span><br><span class="line">    <span class="built_in">MPI_Comm_group</span>(MPI_COMM_WORLD, &amp;world_group);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建包含前半部分进程的新进程组</span></span><br><span class="line">    <span class="type">int</span> half_size = size / <span class="number">2</span>;</span><br><span class="line">    <span class="type">int</span> *ranks = (<span class="type">int</span> *)<span class="built_in">malloc</span>(half_size * <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; half_size; i++) &#123;</span><br><span class="line">        ranks[i] = i;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    MPI_Group new_group;</span><br><span class="line">    <span class="built_in">MPI_Group_incl</span>(world_group, half_size, ranks, &amp;new_group);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用新进程组创建新的通信域</span></span><br><span class="line">    MPI_Comm new_comm;</span><br><span class="line">    <span class="built_in">MPI_Comm_create</span>(MPI_COMM_WORLD, new_group, &amp;new_comm);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在新通信域中进行操作</span></span><br><span class="line">    <span class="keyword">if</span> (new_comm != MPI_COMM_NULL) &#123;</span><br><span class="line">        <span class="type">int</span> new_rank, new_size;</span><br><span class="line">        <span class="built_in">MPI_Comm_rank</span>(new_comm, &amp;new_rank);</span><br><span class="line">        <span class="built_in">MPI_Comm_size</span>(new_comm, &amp;new_size);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> data = new_rank;</span><br><span class="line">        <span class="comment">// 广播数据</span></span><br><span class="line">        <span class="built_in">MPI_Bcast</span>(&amp;data, <span class="number">1</span>, MPI_INT, <span class="number">0</span>, new_comm);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Process %d in new_comm received data %d\n&quot;</span>, new_rank, data);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 规约操作</span></span><br><span class="line">        <span class="type">int</span> sum;</span><br><span class="line">        <span class="built_in">MPI_Reduce</span>(&amp;data, &amp;sum, <span class="number">1</span>, MPI_INT, MPI_SUM, <span class="number">0</span>, new_comm);</span><br><span class="line">        <span class="keyword">if</span> (new_rank == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Sum of ranks in new_comm: %d\n&quot;</span>, sum);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 释放通信域</span></span><br><span class="line">    <span class="built_in">MPI_Comm_free</span>(&amp;new_comm);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 释放进程组</span></span><br><span class="line">    <span class="built_in">MPI_Group_free</span>(&amp;world_group);</span><br><span class="line">    <span class="built_in">MPI_Group_free</span>(&amp;new_group);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">MPI_Finalize</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>
        <div id="lv-container"></div>
        <div class="giscus"></div>
    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    

<p id="hitokoto">加载中...</p>

<script>
    fetch('https://tenapi.cn/v2/yiyan')
        .then(response => response.text())
        .then(text => {
            document.getElementById('hitokoto').innerText = text;
        })
        .catch(error => {
            console.error('请求失败:', error);
        });
</script>
 <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>
 </p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

<script src="/js/index.js"></script>

<!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> -->






</html>
